---
openapi: 3.0.3
info:
  title: comanda-api-interna
  version: 0.1.0
servers:
  - url: ""
tags:
  - name: COMANDA → APP / Estadístiques
    description: Contracte d'API d'estadístiques que COMANDA pot consultar a les APPs
  - name: COMANDA → APP / Salut
    description: Contracte d'API de salut i metadades de l'aplicació que COMANDA pot
      consultar
paths:
  /api/v1/estadistiques:
    get:
      tags:
        - COMANDA → APP / Estadístiques
      operationId: EstadistiquesApiController.estadistiques
      description: Retorna registres d'estadístiques més recents disponibles.
      summary: Darrera captura d'estadístiques
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                description: Registres estadístics d'un instant de temps amb les seves
                  mesures
                $ref: '#/components/schemas/RegistresEstadistics'
      x-operation-name: estadistiques
  /api/v1/estadistiques/Info:
    get:
      tags:
        - COMANDA → APP / Estadístiques
      operationId: EstadistiquesApiController.statsInfo
      description: Retorna el codi de l'app i el catàleg de dimensions i indicadors
        disponibles.
      summary: Informació d'estadístiques
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                description: Catàleg de dimensions i indicadors d'estadística disponibles
                  per a una APP
                $ref: '#/components/schemas/EstadistiquesInfo'
      x-operation-name: statsInfo
  /api/v1/estadistiques/from/{dataInici}/to/{dataFi}:
    get:
      tags:
        - COMANDA → APP / Estadístiques
      operationId: EstadistiquesApiController.estadistiques2
      description: Retorna llista d'estadístiques des de dataInici fins a dataFi (ambdues
        dd-MM-yyyy).
      summary: Estadístiques per interval
      parameters:
        - name: arg1
          in: path
          required: true
          schema:
            type: string
        - name: arg2
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  description: Registres estadístics d'un instant de temps amb les
                    seves mesures
                  $ref: '#/components/schemas/RegistresEstadistics'
      x-operation-name: estadistiques
  /api/v1/estadistiques/of/{data}:
    get:
      tags:
        - COMANDA → APP / Estadístiques
      operationId: EstadistiquesApiController.estadistiques3
      description: Retorna estadístiques corresponents a la data indicada amb format
        dd-MM-yyyy.
      summary: Estadístiques d'una data
      parameters:
        - name: arg1
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                description: Registres estadístics d'un instant de temps amb les seves
                  mesures
                $ref: '#/components/schemas/RegistresEstadistics'
      x-operation-name: estadistiques
  /api/v1/appInfo:
    get:
      tags:
        - COMANDA → APP / Salut
      operationId: SalutApiController.appInfo
      description: "Retorna dades bàsiques de l'aplicació (codi, nom, versió, data\
        \ de build, etc.) i contextos exposats."
      summary: Informació de l'aplicació
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                description: Informació bàsica de l'aplicació consultada per COMANDA
                $ref: '#/components/schemas/AppInfo'
      x-operation-name: appInfo
  /api/v1/salut:
    get:
      tags:
        - COMANDA → APP / Salut
      operationId: SalutApiController.health
      description: "Retorna l'estat de salut funcional i integracions, amb metadades\
        \ de versió."
      summary: Estat de salut funcional
      responses:
        200:
          description: successful operation
          content:
            application/json:
              schema:
                description: Estat de salut funcional de l'aplicació i metadades associades
                $ref: '#/components/schemas/SalutInfo'
      x-operation-name: health
components:
  schemas:
    AppInfo:
      description: Informació bàsica de l'aplicació consultada per COMANDA
      required:
        - codi
        - nom
        - versio
        - data
      type: object
      properties:
        codi:
          description: Codi identificador de l'aplicació
          type: string
          minLength: 1
          example: NOTIB
        nom:
          description: Nom complet de l'aplicació
          type: string
          minLength: 1
          example: NOTIB - Notificacions
        versio:
          description: Versió desplegada de l'aplicació
          type: string
          minLength: 1
          example: 1.4.3
        data:
          description: Data de compilació o de la informació reportada
          type: string
          format: date-time
        revisio:
          description: Revisió o identificador de commit de la build
          type: string
          example: a1b2c3d
        jdkVersion:
          description: Versió de JDK amb la qual s'executa l'aplicació
          type: string
          example: Temurin-17.0.9
        integracions:
          description: Llista d'integracions exposades per l'aplicació
          type: array
          items:
            description: Informació d'una integració exposada per l'aplicació
            $ref: '#/components/schemas/IntegracioInfo'
        subsistemes:
          description: Llista de subsistemes interns amb el seu estat
          type: array
          items:
            description: Informació d'un subsistema intern de l'aplicació
            $ref: '#/components/schemas/SubsistemaInfo'
        contexts:
          description: Contextos o endpoints base exposats per l'aplicació
          type: array
          items:
            description: Context o 'namespace' funcional exposat per l'aplicació
            $ref: '#/components/schemas/ContextInfo'
    ContextInfo:
      description: Context o 'namespace' funcional exposat per l'aplicació
      required:
        - codi
        - nom
        - path
      type: object
      properties:
        codi:
          description: Codi del context
          type: string
          minLength: 1
          example: public
        nom:
          description: Nom descriptiu del context
          type: string
          minLength: 1
          example: Context públic
        path:
          description: Path base del context
          type: string
          minLength: 1
          example: /app/public
        manuals:
          description: Llista de manuals associats al context
          type: array
          items:
            description: Referència a un manual o documentació funcional
            $ref: '#/components/schemas/Manual'
        api:
          description: "URL o especificació OpenAPI del context, si està disponible"
          type: string
          example: https://dev.caib.es/app/public/openapi.json
    DetallSalut:
      description: Detall específic d'estat de salut (parella clau-valor)
      required:
        - codi
        - nom
        - valor
      type: object
      properties:
        codi:
          description: Codi del detall
          type: string
          minLength: 1
          example: latencia-db
        nom:
          description: Nom del detall
          type: string
          minLength: 1
          example: Latència BD
        valor:
          description: Valor del detall
          type: string
          minLength: 1
          example: 120ms
    DiaSetmanaEnum:
      type: string
      enum:
        - DL
        - DM
        - DC
        - DJ
        - DV
        - DS
        - DG
    Dimensio:
      type: object
      properties:
        codi:
          type: string
        valor:
          type: string
    DimensioDesc:
      required:
        - codi
        - nom
      type: object
      properties:
        codi:
          type: string
          minLength: 1
          maxLength: 32
        nom:
          type: string
          minLength: 1
          maxLength: 64
        descripcio:
          type: string
        valors:
          type: array
          items:
            type: string
    EstadistiquesInfo:
      description: Catàleg de dimensions i indicadors d'estadística disponibles per
        a una APP
      required:
        - codi
        - dimensions
        - indicadors
      type: object
      properties:
        codi:
          description: Codi identificador de l'aplicació
          type: string
          minLength: 1
          example: NOTIB
        versio:
          description: Versió de l'aplicació
          type: string
          example: 1.4.3
        data:
          description: Data de generació de la informació
          type: string
          format: date-time
        dimensions:
          description: Dimensions estadístiques disponibles
          type: array
          items:
            $ref: '#/components/schemas/DimensioDesc'
        indicadors:
          description: Indicadors estadístics disponibles
          type: array
          items:
            description: Descripció d'un indicador/mesura disponible
            $ref: '#/components/schemas/IndicadorDesc'
    EstatSalut:
      type: object
      properties:
        estat:
          description: Enumerat d'estats possibles de salut d'un component
          $ref: '#/components/schemas/EstatSalutEnum'
        latencia:
          type: integer
          format: int32
    EstatSalutEnum:
      description: Enumerat d'estats possibles de salut d'un component
      type: string
      enum:
        - UP
        - WARN
        - DEGRADED
        - DOWN
        - MAINTENANCE
        - UNKNOWN
        - ERROR
    Fet:
      type: object
      properties:
        codi:
          type: string
        valor:
          type: number
          format: double
    Format:
      type: string
      enum:
        - LONG
        - DECIMAL
        - PERCENTAGE
        - CURRENCY
        - DATE
        - DATETIME
        - BOOLEAN
    IndicadorDesc:
      description: Descripció d'un indicador/mesura disponible
      required:
        - codi
        - nom
      type: object
      properties:
        codi:
          description: Codi de l'indicador
          type: string
          minLength: 1
          maxLength: 32
          example: visites
        nom:
          description: Nom de l'indicador
          type: string
          minLength: 1
          maxLength: 64
          example: Nombre de visites
        descripcio:
          description: Descripció funcional de l'indicador
          type: string
          example: Total de visites registrades per període
        format:
          description: Format de representació del valor de l'indicador
          $ref: '#/components/schemas/Format'
    IntegracioInfo:
      description: Informació d'una integració exposada per l'aplicació
      required:
        - codi
        - nom
      type: object
      properties:
        codi:
          description: Codi identificador de la integració
          type: string
          minLength: 1
          example: NOTIB
        nom:
          description: Nom descriptiu de la integració
          type: string
          minLength: 1
          example: NOTIB - Notificacions
    IntegracioPeticions:
      description: "Mètriques de peticions d'una integració: totals i darrer perí\
        ode"
      required:
        - totalOk
        - totalError
        - totalTempsMig
        - peticionsOkUltimPeriode
        - peticionsErrorUltimPeriode
        - tempsMigUltimPeriode
      type: object
      properties:
        totalOk:
          description: Nombre total de peticions amb resultat correcte
          type: integer
          format: int64
        totalError:
          description: Nombre total de peticions amb error
          type: integer
          format: int64
        totalTempsMig:
          description: Temps mig total de resposta (ms)
          type: integer
          format: int32
        peticionsOkUltimPeriode:
          description: Peticions OK en el darrer període
          type: integer
          format: int64
        peticionsErrorUltimPeriode:
          description: Peticions en error en el darrer període
          type: integer
          format: int64
        tempsMigUltimPeriode:
          description: Temps mig de resposta en el darrer període (ms)
          type: integer
          format: int32
        endpoint:
          description: Endpoint concret associat a aquestes mètriques
          type: string
          minLength: 0
          maxLength: 255
          example: /api/v1/notificacions
        peticionsPerEntorn:
          description: Mètriques per entorn (clau = codi d'entorn)
          type: object
          additionalProperties:
            description: "Mètriques de peticions d'una integració: totals i darrer\
              \ període"
            $ref: '#/components/schemas/IntegracioPeticions'
    IntegracioSalut:
      description: Estat de salut d'una integració concreta
      required:
        - codi
      type: object
      properties:
        estat:
          description: Enumerat d'estats possibles de salut d'un component
          $ref: '#/components/schemas/EstatSalutEnum'
        latencia:
          type: integer
          format: int32
        codi:
          description: Codi de la integració
          type: string
          minLength: 1
          example: NOTIB
        peticions:
          description: Mètriques de peticions associades a la integració
          $ref: '#/components/schemas/IntegracioPeticions'
    Manual:
      description: Referència a un manual o documentació funcional
      required:
        - nom
        - path
      type: object
      properties:
        nom:
          description: Nom del manual
          type: string
          minLength: 1
          example: Guia d'usuari
        path:
          description: Ruta o URL del manual
          type: string
          minLength: 1
          example: https://www.caib.es/docs/guia-usuari.pdf
    MissatgeSalut:
      description: Missatge informatiu/alerta de salut amb nivell de gravetat
      required:
        - data
        - nivell
        - missatge
      type: object
      properties:
        data:
          description: Instant del missatge
          type: string
          format: date-time
        nivell:
          description: Nivell de gravetat del missatge
          $ref: '#/components/schemas/SalutNivell'
        missatge:
          description: Text del missatge
          type: string
          minLength: 1
          example: Manteniment programat a les 22:00h
    RegistreEstadistic:
      description: Registre d'estadística amb dimensions i fets associats
      type: object
      properties:
        dimensions:
          description: "Dimensions que qualifiquen el registre (p. ex. àrea, tipus,\
            \ canal)"
          type: array
          items:
            $ref: '#/components/schemas/Dimensio'
        fets:
          description: Fets o mesures quantitatives associades al registre
          type: array
          items:
            $ref: '#/components/schemas/Fet'
    RegistresEstadistics:
      description: Registres estadístics d'un instant de temps amb les seves mesures
      required:
        - temps
      type: object
      properties:
        temps:
          description: "Informació temporal associada als registres (data/hora, perí\
            ode, etc.)"
          $ref: '#/components/schemas/Temps'
        fets:
          description: Llista de registres o fets estadístics recollits en l'instant
            indicat
          type: array
          items:
            description: Registre d'estadística amb dimensions i fets associats
            $ref: '#/components/schemas/RegistreEstadistic'
    SalutInfo:
      description: Estat de salut funcional de l'aplicació i metadades associades
      required:
        - codi
        - data
        - estat
        - bd
      type: object
      properties:
        codi:
          description: Codi identificador de l'aplicació
          type: string
          minLength: 1
          example: NOTIB
        data:
          description: Instant de generació de l'estat de salut
          type: string
          format: date-time
        estat:
          description: Estat global de l'aplicació
          $ref: '#/components/schemas/EstatSalut'
        bd:
          description: Estat de la base de dades
          $ref: '#/components/schemas/EstatSalut'
        integracions:
          description: Integracions amb el seu estat
          type: array
          items:
            description: Estat de salut d'una integració concreta
            $ref: '#/components/schemas/IntegracioSalut'
        altres:
          description: Altres detalls rellevants de salut
          type: array
          items:
            description: Detall específic d'estat de salut (parella clau-valor)
            $ref: '#/components/schemas/DetallSalut'
        missatges:
          description: Missatges informatius o d'alerta
          type: array
          items:
            description: Missatge informatiu/alerta de salut amb nivell de gravetat
            $ref: '#/components/schemas/MissatgeSalut'
        versio:
          description: Versió de l'aplicació
          type: string
          example: 1.4.3
        subsistemes:
          description: Subsistemes interns amb el seu estat
          type: array
          items:
            description: Estat de salut i mètriques d'un subsistema intern
            $ref: '#/components/schemas/SubsistemaSalut'
    SalutNivell:
      description: Nivell de gravetat d'un missatge de salut
      type: string
      enum:
        - ERROR
        - WARN
        - INFO
    SubsistemaInfo:
      description: Informació d'un subsistema intern de l'aplicació
      required:
        - codi
        - nom
      type: object
      properties:
        codi:
          description: Codi del subsistema
          type: string
          minLength: 1
          example: BD
        nom:
          description: Nom del subsistema
          type: string
          minLength: 1
          example: Base de Dades
    SubsistemaSalut:
      description: Estat de salut i mètriques d'un subsistema intern
      required:
        - codi
        - totalOk
        - totalError
        - totalTempsMig
        - peticionsOkUltimPeriode
        - peticionsErrorUltimPeriode
        - tempsMigUltimPeriode
      type: object
      properties:
        estat:
          description: Enumerat d'estats possibles de salut d'un component
          $ref: '#/components/schemas/EstatSalutEnum'
        latencia:
          type: integer
          format: int32
        codi:
          description: Codi del subsistema
          type: string
          minLength: 1
          example: BD
        totalOk:
          description: Total de peticions amb resultat correcte
          type: integer
          format: int64
        totalError:
          description: Total de peticions amb error
          type: integer
          format: int64
        totalTempsMig:
          description: Temps mig total de resposta (ms)
          type: integer
          format: int32
        peticionsOkUltimPeriode:
          description: Peticions OK en el darrer període
          type: integer
          format: int64
        peticionsErrorUltimPeriode:
          description: Peticions en error en el darrer període
          type: integer
          format: int64
        tempsMigUltimPeriode:
          description: Temps mig de resposta en el darrer període (ms)
          type: integer
          format: int32
    Temps:
      description: Desglossament temporal associat als registres d'estadística
      required:
        - data
      type: object
      properties:
        data:
          description: Instant temporal de referència
          type: string
          format: date-time
        anualitat:
          description: Any corresponent a la data
          type: integer
          format: int32
          example: 2025
        trimestre:
          description: Trimestre (1-4) derivat de la data
          type: integer
          format: int32
          example: 4
        mes:
          description: Mes (1-12) derivat de la data
          type: integer
          format: int32
          example: 11
        setmana:
          description: Setmana de l'any derivada de la data
          type: integer
          format: int32
          example: 47
        diaSetmana:
          description: Dia de la setmana
          $ref: '#/components/schemas/DiaSetmanaEnum'
        dia:
          description: Dia del mes
          type: integer
          format: int32
          example: 25
