import * as React from 'react';
import { useTranslation } from 'react-i18next';
import {
    MuiDataGrid,
    MuiFilter,
    FormField,
    springFilterBuilder,
    useFormApiRef,
    useFilterApiRef,
    MuiDataGridColDef, useResourceApiService, useBaseAppContext, useMuiDataGridApiRef,
} from 'reactlib';
import Box from '@mui/material/Box';
import Grid from '@mui/material/Grid';
import Icon from '@mui/material/Icon';
import IconButton from '@mui/material/IconButton';
import Button from '@mui/material/Button';
import {countLeaves, useTreeData} from '../hooks/treeData';
import { formatEndOfDay, formatStartOfDay } from '../util/dateUtils.ts';
import {
    gridRowTreeSelector,
    GridSortModel, GridTreeDataGroupingCell, isAutogeneratedRow,
    useGridApiContext,
    useGridApiRef,
    useGridSelector
} from '@mui/x-data-grid-pro';
import {Chip, SxProps} from '@mui/material';
import { useUserContext } from '../components/UserContext';
import PageTitle from '../components/PageTitle.tsx';
import {useEffect, useMemo, useRef} from "react";

const useActions = (refresh?: () => void) => {
    const { t } = useTranslation();
    const {isReady: apiIsReady, artifactAction: apiAction} = useResourceApiService('avis')
    const { temporalMessageShow } = useBaseAppContext();

    const marcarLlegit = (id:any) => {
        marcarLlegit([id])
    }
    const marcarLlegitMassive = (ids:any[]) => {
        apiAction(undefined, {code: 'MARCAR_AVIS_LLEGIT', data: {ids, llegit: true}})
            .then(() => {
                refresh?.();
                temporalMessageShow(null, t($ => $.page.avisos.action.llegit.ok), 'success');
            })
            .catch((error) => {
                if (error?.message) {
                    temporalMessageShow(null, error?.message, 'error');
                }
            });
    }

    const marcarNoLlegit = (id:any) => {
        marcarNoLlegitMassive(id)
    }

    const marcarNoLlegitMassive = (ids:any[]) => {
        apiAction(undefined, {code: 'MARCAR_AVIS_LLEGIT', data: {ids, llegit: false}})
            .then(() => {
                refresh?.();
                temporalMessageShow(null, t($ => $.page.avisos.action.nollegit.ok), 'success');
            })
            .catch((error) => {
                if (error?.message) {
                    temporalMessageShow(null, error?.message, 'error');
                }
            });
    }

    return {apiIsReady, marcarLlegit, marcarLlegitMassive, marcarNoLlegit, marcarNoLlegitMassive}
}

const AvisFilter = (props: { onSpringFilterChange: (springFilter: string | undefined) => void, setNoLlegit?: (value:boolean) => void }) => {
    const { onSpringFilterChange, setNoLlegit } = props;
    const { t } = useTranslation();
    const { user } = useUserContext();
    const [ownAvisOnly, setOwnAvisOnly] = React.useState<boolean>(true);
    const [moreFields, setMoreFields] = React.useState<boolean>(false);
    const appEntornFilterApiRef = useFilterApiRef();
    const moreFilterApiRef = useFilterApiRef();
    const moreFormApiRef = useFormApiRef();
    const netejar = () => {
        appEntornFilterApiRef?.current?.clear();
        moreFilterApiRef?.current?.clear();
    }
    React.useEffect(() => {
        moreFormApiRef.current?.setFieldValue('avisPropi', ownAvisOnly);
    }, [ownAvisOnly]);

    const currentUsername = user?.codi;
    const ownAvisOnlyFilterAvailable = currentUsername != null;

    return (
        <>
            <MuiFilter
                apiRef={appEntornFilterApiRef}
                resourceName="entornApp"
                code="optional_entornApp_filter"
                commonFieldComponentProps={{ size: 'small' }}
                springFilterBuilder={data => {
                    moreFormApiRef.current?.setFieldValue('appId', data.app);
                    moreFormApiRef.current?.setFieldValue('entornId', data.entorn);
                    return '';
                }}>
                <Box sx={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <Grid container spacing={1} sx={{ flexGrow: 1, mr: 1 }}>
                        <Grid size={6}><FormField name="app" /></Grid>
                        <Grid size={6}><FormField name="entorn" /></Grid>
                    </Grid>
                    <Button
                        onClick={() => setOwnAvisOnly(value => !value)}
                        disabled={!ownAvisOnlyFilterAvailable}
                        variant={ownAvisOnly ? 'contained' : 'outlined'}
                        title={ownAvisOnly ? t($ => $.page.avisos.filter.ownAvisOnlyEnabled) : t($ => $.page.avisos.filter.ownAvisOnlyDisabled)}
                        sx={{ mr: 2 }}>
                        <Icon>person</Icon>
                    </Button>
                    <IconButton
                        onClick={netejar}
                        title={t($ => $.components.clear)}
                        sx={{ mr: 1 }}>
                        <Icon>filter_alt_off</Icon>
                    </IconButton>
                    <IconButton
                        onClick={() => setMoreFields((mf) => !mf)}
                        title={t($ => $.page.avisos.filter.more)}>
                        <Icon>filter_list</Icon>
                    </IconButton>
                </Box>
            </MuiFilter>
            <MuiFilter
                apiRef={moreFilterApiRef}
                formApiRef={moreFormApiRef}
                resourceName="avis"
                code="FILTER"
                initialData={{ avisPropi: ownAvisOnly, noLlegit: true }}
                springFilterBuilder={(data:any) => {
                    setNoLlegit?.(data?.noLlegit)
                    return springFilterBuilder.and(
                        springFilterBuilder.eq('appId', data?.appId?.id),
                        springFilterBuilder.eq('entornId', data?.entornId?.id),
                        springFilterBuilder.like('nom', data?.nom),
                        springFilterBuilder.like('descripcio', data?.descripcio),
                        springFilterBuilder.eq('tipus', data?.tipus),
                        data?.dataInici1 && springFilterBuilder.gte('dataInici', `'${formatStartOfDay(data?.dataInici1)}'`),
                        data?.dataInici2 && springFilterBuilder.lte('dataInici', `'${formatEndOfDay(data?.dataInici2)}'`),
                        data?.avisPropi && ownAvisOnlyFilterAvailable && springFilterBuilder.eq('responsable', `'${currentUsername}'`),
                    )
                }}
                onSpringFilterChange={onSpringFilterChange}
                commonFieldComponentProps={{ size: 'small' }}>
                <Grid container spacing={1} sx={{ display: moreFields ? undefined : 'none', mt: 1 }}>
                    <Grid size={{ xs: 12, sm:4}}><FormField name="nom" /></Grid>
                    <Grid size={{ xs: 6, sm:4}}><FormField name="descripcio" /></Grid>
                    <Grid size={{ xs: 6, sm:4}}><FormField name="tipus" /></Grid>
                    <Grid size={{ xs: 5 }}><FormField name="dataInici1" /></Grid>
                    <Grid size={{ xs: 5 }}><FormField name="dataInici2" /></Grid>
                    <Grid size={{ xs: 2 }}><FormField name="noLlegit" type={'checkbox'}/></Grid>
                </Grid>
            </MuiFilter>
        </>
    );
}

const StyledLlegit = ({llegit, children}:any) => {
    return llegit ?<i>{children}</i> :<strong>{children}</strong>
}

const dataGridCommonColumns: MuiDataGridColDef[] = [{
    field: 'descripcio',
    flex: 1,
    renderCell: (params: any) => <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit>,
}, {
    field: 'tipus',
    flex: 0.5,
    renderCell: (param) => {
        let style: SxProps = {};
        switch (param?.row?.tipus) {
            case 'NOTICIA':
                style = { backgroundColor: 'success.main', color: 'white' }
                break;
            case 'INFO':
                style = { backgroundColor: 'info.main', color: 'white' }
                break;
            case 'ALERTA':
                style = { backgroundColor: 'warning.main', color: 'white' }
                break;
            case 'ERROR':
                style = { backgroundColor: 'error.main', color: 'white' }
                break;
            case 'CRITIC':
                style = { backgroundColor: '#6b0707', color: 'white' }
                break;
        }
        return param?.formattedValue && <Chip label={param?.formattedValue} size={"small"} sx={style} />
    }
}, {
    field: 'responsable',
    flex: 1,
    renderCell: (params: any) => <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit>,
}];
const dataGridPerspectives = ['PATH', 'ENTORN_APP', 'LLEGIT'];
const dataGridSortModel: GridSortModel = [{ field: 'dataInici', sort: 'asc' }];

const Avis = () => {
    const { t } = useTranslation();
    const [noLlegit, setNoLlegit] = React.useState<boolean>();
    const [filter, setFilter] = React.useState<string>();
    const [apps, setApps] = React.useState<any[]>();
    const apiRef = useMuiDataGridApiRef();
    const gridApiRef = useGridApiRef();

    const { isReady: apiIsReady, find: apiFind } = useResourceApiService('app');
    useEffect(() => {
        if (apiIsReady) {
            apiFind({unpaged: true})
                .then((response) => setApps(response?.rows) )
        }
    }, [apiIsReady]);

    const {
        treeView,
        treeViewSwitch,
        dataGridProps: treeDataGridProps,
    } = useTreeData(
        (row) => row?.treePath,
        gridApiRef,
        t($ => $.page.avisos.grid.groupHeader),
        1.5,
        false,
        false,
        {
            valueFormatter: (value: any, row: any) => row?.id ? row?.nom : value,
            renderCell: (params: any) => {
                const apiRef = useGridApiContext();
                const rowTree = useGridSelector(apiRef, gridRowTreeSelector);

                const count = countLeaves(params.id, rowTree)
                const app = apps?.find((a) => a?.nom == params?.value)
                return (
                    <GridTreeDataGroupingCell {...params} formattedValue={<>
                        {isAutogeneratedRow(params?.row) && (app!=null
                            ? <Box
                                sx={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                }}
                            >
                                {app?.logo && (
                                    <img
                                        src={'data:image/png;base64,' + app?.logo}
                                        alt={`Logo ${app?.nom}`}
                                        style={{ height: '48px' }}
                                    />
                                )}
                                {params.formattedValue}
                                {!params?.row?.id && <Chip label={count} size="small" sx={{ml: 1}}/>}
                            </Box>
                            : <>
                                {params.formattedValue}
                                {!params?.row?.id && <Chip label={count} size="small" sx={{ml: 1}}/>}
                            </>)
                        }
                        {!isAutogeneratedRow(params?.row) &&
                            <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit> }
                    </>} hideDescendantCount />
                );
            },
        });
    const columns: MuiDataGridColDef[] = useMemo(() => [
        ...(!treeView
            ? [
                {
                    field: 'logo',
                    headerName: '',
                    flex: 0.5,
                    sortable: false,
                    disableColumnMenu: true,
                    renderCell: (params: any) => {
                        const app = apps?.find((a) => a?.id == params?.row?.app?.id)
                        return (
                            <Box
                                sx={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                }}
                            >
                                {app?.logo && (
                                    <img
                                        src={'data:image/png;base64,' + app?.logo}
                                        alt={`Logo ${app?.nom}`}
                                        style={{ height: '48px' }}
                                    />
                                )}
                            </Box>
                        );
                    },
                },
                { field: 'app', flex: 0.5, valueFormatter: (value: any) => value?.description,
                    renderCell: (params: any) => <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit>,
                },
                { field: 'entorn', flex: 1, valueFormatter: (value: any) => value?.description,
                    renderCell: (params: any) => <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit>,
                },
                { field: 'nom', flex: 1,
                    renderCell: (params: any) => <StyledLlegit llegit={params?.row?.llegit}>{params?.formattedValue}</StyledLlegit>,
                },
              ]
            : []),
        ...dataGridCommonColumns,
        {
            field: 'dataInici',
            headerName: t($ => $.page.message.grid.timestamp),
            width: 150,
        }
    ], [t, treeView, apps]);

    const refresh = () => {
        apiRef?.current?.refresh?.();
    }
    const {apiIsReady: actionIsReady, marcarLlegit, marcarLlegitMassive, marcarNoLlegit, marcarNoLlegitMassive} = useActions(refresh)

    const actions = useMemo(() => [
        {
            icon: 'open_in_new',
            label: t($ => $.page.avisos.action.obrir),
            showInMenu: false,
            linkTo: (row: any) => row?.url,
            linkTarget: '_blank',
            onClick: (id:any, row:any) => {
                if (!row?.llegit) {
                    marcarLlegit(id)
                }
            },
            disabled: (row: any) => !row?.url,
            hidden: (row: any) => !row?.url,
        }, {
            icon: 'drafts',
            label: t($ => $.page.avisos.action.llegit.label),
            showInMenu: true,
            onClick: marcarLlegit,
            hidden: (row:any) => isAutogeneratedRow(row) || row?.llegit,
        }, {
            icon: 'mail',
            label: t($ => $.page.avisos.action.nollegit.label),
            showInMenu: true,
            onClick: marcarNoLlegit,
            hidden: (row:any) => isAutogeneratedRow(row) || !row?.llegit,
        }
    ], [t, actionIsReady]);
    const filterElement = <AvisFilter onSpringFilterChange={setFilter} setNoLlegit={setNoLlegit}/>;

    const selectedRows = useRef<string[]>([])
    const toolbarAdditionalActions:any[] = [
        { position: 1, element: treeViewSwitch },
        {
            position: 2,
            element: (
                <Button
                    title={t($ => $.page.avisos.action.llegit.label)}
                    onClick={() => marcarLlegitMassive(selectedRows?.current)}
                    endIcon={<Icon>drafts</Icon>}
                >
                    {t($ => $.page.avisos.action.llegit.label)}
                </Button>
            ),
        },
        {
            position: 2,
            element: (
                <Button
                    title={t($ => $.page.avisos.action.nollegit.label)}
                    onClick={() => marcarNoLlegitMassive(selectedRows?.current)}
                    endIcon={<Icon>mail</Icon>}
                >
                    {t($ => $.page.avisos.action.nollegit.label)}
                </Button>
            ),
        },
    ];

    return (
        <Box sx={{ height: '100%' }}>
            <PageTitle title={t($ => $.menu.avis)} />
            <MuiDataGrid
                apiRef={apiRef}
                title={t($ => $.menu.avis)}
                resourceName="avis"
                columns={columns}
                perspectives={dataGridPerspectives}
                datagridApiRef={gridApiRef}
                sortModel={dataGridSortModel}
                findDisabled={filter == null}
                filter={filter}
                namedQueries={noLlegit?['avis_no_llegit']:[]}
                readOnly
                toolbarType="upper"
                toolbarHideQuickFilter
                toolbarElementsWithPositions={toolbarAdditionalActions}
                toolbarAdditionalRow={filterElement}
                rowAdditionalActions={actions}
                {...treeDataGridProps}
                initialState={{
                    columns: {
                        columnVisibilityModel: {
                            entorn: false,
                        },
                    },
                }}
                selectionActive
                onRowSelectionModelChange={(rowSelectionModel: any) => {
                    selectedRows.current = Array.from(rowSelectionModel?.ids) ?? []
                }}
                // isRowSelectable={(params:any) => params?.row?.id}
            />
        </Box>
    );
}

export default Avis;
